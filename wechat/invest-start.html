<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="keywords" content="八斗金服">
  <meta name="description" content="八斗金服">
  <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <meta name="apple-mobile-web-app-capable" content="no" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="x5-fullscreen" content="true">
  <meta name="full-screen" content="yes">
  <!--<base href="http://192.168.0.220:8022/" />-->
  <title>智享计划</title>
  <link rel="stylesheet" type="text/css" href="weixin/css/wechat.css" />
  <script src="weixin/js/require.js" data-main="weixin/js/main" defer="defer" async="async" type="text/javascript" charset="utf-8"></script>
  <script>
    window.onload = function () {
      require.config({
        baseUrl: 'weixin/js',
        paths: {
          'jquery': [
            '//cdn.bootcss.com/jquery/1.12.4/jquery.min',
            'lib/jquery/1.12.4/jquery.min'
          ],
          'config': 'settings',
          'util': 'common/util',
          'AsyncTaskManager': 'common/asyncTaskManager',
          'WebView': 'common/webView',
          'Asset': 'model/asset',
          'userController': 'controller/userController',
          'investController': 'controller/investController',
          'appController': 'controller/appController'
        }
      });
      require([
        'jquery', 'config', 'util', 'AsyncTaskManager', 'WebView', 'Asset', 'userController', 'investController',
        'appController'
      ], function ($, config, util, AsyncTaskManager, WebView, Asset, userController, investController,
        appController) {
        var $invest = $('#investImmediately'),
          timer = null,
          headerColors = ['#19c8b7', '#f9364e', '#fd611d', '#5cc5f0'];

        $('#lockPeriod').val('-1');
        $('#investment').val('');

        try {
          var atm = AsyncTaskManager.of()
            .addTask(investController.loadRateByPeriod, 0)
            .addTask(investController.loadRateByPeriod, 6)
            .every(function (res) {
              res.sort(function (a, b) {
                return parseFloat(a, 10) < parseFloat(b, 10) ? -1 : 1;
              })
              $('#zhixiangRrofit').css('background-color', headerColors[1]);
              $('#yieldRate').html(res.join('~'));
            });
        } catch (error) {
          // alert(error)
        }

        $('#indicator').fadeIn(300);
        $('#buttonTitle').html('数据加载中...');
        var asm = AsyncTaskManager.of()
          .addTask(userController.getMyAsset)
          .addTask(userController.loadUserAuthResult)
          .every(function (res) {
            $('#loading').hide(0);
            $('#loaded').show();
            var __t = setTimeout(function () {
              var user = res[0],
                asset = res[1],
                balance;
              if (!(asset instanceof Asset)) {
                asset = res[0];
                user = res[1];
              }

              balance = asset.getCABalance();
              $('#acountBalance').html(balance);
              if (!user.getIsAuth()) {
                $('#buttonTitle').html('进入实名认证');
                $invest.on('click', function () {
                  util.jump2RealNameAuthPage(window.location.href);
                });
              } else if (!user.getIsSign()) {
                $('#buttonTitle').html('请开通安心签');
                $invest.on('click', function () {
                  $('#peaceSign').fadeIn();
                });
              } else {
                $('#buttonTitle').html('下一步');
                $invest.on('click', doInvest);
              }
            }, 1400);
          });

        function doInvest() {
          if (!/^[1-9][0-9]*0{2}$/.test($('#investment').val())) {
            WebView.msgAlert({
              msg: '请输入有效的预约金额<br/>（100的整数倍）'
            }).show();
            return;
          }
          if (+$('#lockPeriod').val() < 0) {
            WebView.msgAlert({
              msg: '请选择锁定期'
            }).show();
            return;
          }
          if(parseInt($('#investment').val(), 10) > parseInt($('#acountBalance').html(), 10)){
            WebView.msgAlert({
              msg: '余额不足，请<a href="/recharge.1.html" style="color:#f9364e">充值</a>'
            }).show();
            return;
          }
          window.location = config.BASE_URL + config.PAGE_URI_MAP.PAY_PAGE + '?' + $.param({
            money: $('#investment').val(),
            lockperiod: $('#lockPeriod').val(),
            balance: $('#acountBalance').html(),
            rate: $('#yieldRate').html(),
            lx: $('#_lx span').html()
          });
        }
        // 计算器
        $('#calculator').on('click', function (e) {
          e.stopPropagation(); //./calculator.html
          window.location = config.BASE_URL + config.PAGE_URI_MAP.CALCULATOR_PAGE;
        });
        // 投资
        $('#confirmCode').on('click', function () {});

        // 获取支付码
        function getPhoneCode() {
          var user = userController.getLoginUserFromLocalStorage();
          var data = {
            codeTag: 'buycode',
            telphone: user && user.getTelphone()
          }
          timer = appController.getPhoneCode(data, $('#getBuyCode'), function (timer) {
            clearInterval(timer);
            $('#getBuyCode').one('click', getPhoneCode);
          });
        }

        // 加载利率
        function updateRate(rate) {
          $('#yieldRate').html(rate);
          calculate();
        }

        function setThemeColor(type) {
          $invest.css('background-color', headerColors[type]);
          // $('#loading').attr('stroke', headerColors[type]);
          // $('#loaded').attr('stroke', headerColors[type]);
          // $('#loadedMark').attr('stroke', headerColors[type]);
          // $('#confirmCode').css('background-color', headerColors[type]);
          $('#zhixiangRrofit').css('background-color', headerColors[type]);
        }
        $('#lockPeriod').on('change', function () {
          var period = $(this).val();
          switch (period) {
            case '-1':
              setThemeColor(1);
              atm.every(function (res) {
                res.sort(function (a, b) {
                  return parseFloat(a, 10) < parseFloat(b, 10) ? -1 : 1;
                });
                $('#yieldRate').html(res.join('~'));
              });
              break;
            case '0':
              setThemeColor(0);
              investController.loadRateByPeriod(0, updateRate)
              break;
            case '4':
              setThemeColor(1);
              investController.loadRateByPeriod(4, updateRate)
              break;
            case '5':
              setThemeColor(2);
              investController.loadRateByPeriod(5, updateRate)
              break;
            case '6':
              setThemeColor(3);
              investController.loadRateByPeriod(6, updateRate)
              break;
            default:
              break;
          }

        });

        // 安心签
        // function getCode() {
        //   user
        // }

        $('#peaceSign').on('click', function () {
          $(this).fadeOut(300);
        });
        $('#peaceSignContent').on('click', function (e) {
          e.stopPropagation();
        });

        var vCount = 30;

        function countUI() {
          $('#obtainYZM').html(vCount-- + '秒后重新获取验授权证码');
          var _tm = setInterval(function () {
            $('#obtainYZM').html(vCount-- + '秒后重新获取验授权证码');
            if (vCount < 0) {
              vCount = 30;
              clearInterval(_tm);
              $('#obtainYZM').html('获取授权验证码');
              // 安心签
              obtainYZM();
            }
          }, 1000);
        }

        $('[name="vcode"]').on('input', checkVerification);

        function checkVerification() {
          var _self = $(this),
            val = $(this).val();
          if (val.length >= 6) {
            _self.blur();
            userController.checkVerification(val, function (res) {
              if (res.getStatus()) {
                $('.payment-phone').html('授权成功');
                $('#buttonTitle').html('下一步');
                setTimeout(function () {
                  $('#peaceSign').fadeOut(300);
                }, 1000);
                $invest.off().on('click', doInvest);
              } else {
                $('.payment-phone').html(res.getMsg());
              }
              _self.val('');
              $('.payment-phone').fadeIn(300);
            });
          }
        }

        obtainYZM();

        function obtainYZM() {
          // 安心签
          $('#obtainYZM').one('click', function () {
            countUI();
            userController.sendverification(function (res) {
              if (res.getStatus()) {
                $('.payment-phone').html('授权验证码已发送到您的手机' + util.replacePhoneNumberUseAsterisk(res.getData()))
                  .fadeIn(300);
              }
            });
          });
        }
        if ($('#investment').val()) {
          $('#investment').removeClass('no-value');
        } else {
          $('#investment').addClass('no-value');
        }
        $('#investment').on('input', function () {
          if (!$(this).val()) {
            $(this).addClass('no-value');
          } else {
            $(this).removeClass('no-value');
          }
          calculate();
        });

        function calculate() {
          var _rate = parseFloat($('#yieldRate').html());
          var _lock = parseInt($('#lockPeriod').val(), 10);
          var _money = parseFloat($('#investment').val());
          var _lx = [];
          if (!_money || _lock < 0) {
            $('#_lx').fadeOut(300);
            return;
          }
          switch (_lock) {
            case 0:
              _lx.push(new Number(_rate * _money / 36500).toFixed(2));
              break;
            case 4:
              _lx.push(new Number(_rate * _money / 1200).toFixed(2));
              _lx.push(new Number(_rate * _money * 3 / 1200).toFixed(2));
              break;
            case 5:
              _lx.push(new Number(_rate * _money * 3 / 1200).toFixed(2));
              _lx.push(new Number(_rate * _money * 6 / 1200).toFixed(2));
              break;
            case 6:
              _lx.push(new Number(_rate * _money * 6 / 1200).toFixed(2));
              _lx.push(new Number(_rate * _money / 100).toFixed(2));
              break;
            default:
              return;
          }
          $('#_lx').html('预期收益&nbsp;<span>' + _lx.join('~') + '</span>&nbsp;元').fadeIn(300);
        }
        window.onhashchange = function(){
          if(window.location.hash == ''){
            $('#red_notice_container').animate({top: '100%'});
          }
        };
        $('#loaded')[0].addEventListener("webkitAnimationEnd", function () {
          $('#loadedMark').show(0);
        }, false);
        $('#closeAlert').on('click', function (e) {
          $('#alertWrapper').fadeOut(300);
        });
        $('#discountCompensation').on('click', function (e) {
          $('#alertWrapper').fadeIn(300);
        });
        $('#slideUpInfo').on('click', function(){
          window.location.hash = '#zx'
          $('#red_notice_container').animate({top: 0});
        });
      });
    };
  </script>
</head>

<body class="zhixiangPlan-page">
  <div class="invest-page-wrapper scroll-wrapper">
    <div class="scroll-content">
      <div id="zhixiangRrofit" class="zhixiang-profit">
        <div id="yieldRate" class="yield-rate">0.0~0.0</div>
        <div class="yieldRate-text">历史年化收益率
          <div>%&nbsp;&nbsp;+&nbsp;&nbsp;
            <div id="discountCompensation" class="discountCompensation"><span>贴息补偿</span></div>
          </div>
        </div>
        <div class="zhixiang-advantage">
          <ul class="clearfix">
            <li style="text-align: left"><span class="nextDaySupplement"></span><span>次日贴息</span></li>
            <li style="text-align: center"><span class="principalInterest"></span><span>本息安心</span></li>
            <li style="text-align: right"><span class="calledAway"></span><span>提前赎回</span></li>
          </ul>
        </div>
      </div>
      <div class="invest-wrapper">
        <div class="invest-wrapper-inner">
          <div class="balance-group inner">
            <span>锁定期</span>
            <!--<span id="bid_balance" class="balance bid-balance novalue">选择锁定期</span>-->
            <a id="targetLockPeriod" class="read-more-arrow" href="javascript:void(0);"></a>
            <select id="lockPeriod" name="lockperiod" class="lock-period">
	            <option value="-1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;选择锁定期</option>
	            <option value="0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;无锁定期</option>
	            <option value="4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1-3个月</option>
	            <option value="5">&nbsp;3个月以上-6个月</option>
	            <option value="6">6个月以上-12个月</option>
	          </select>
          </div>
          <div class="invest-input-group">
            <p class="invest-lable">预约金额(元)</p>
            <input type="tel" id="investment" maxlength="11" name="investment" class="investment no-value" placeholder="请输入预约金额" value=""
            />
            <p style="padding-top:10px;color:#f9364d;opacity:.6">*100的整数倍</p>
          </div>
          <div class="balance-group inner" style="border-bottom: none;border-top:1px solid #e7e7e7">
            <span>账户余额(元)</span>
            <span id="acountBalance" class="balance">0.00</span>
          </div>
          <div style="display:none;padding-bottom: 15px;color:rgb(25,200,183);text-align:right" id="_lx"></div>
        </div>
      </div>
      <div class="intelligent-financing">
        <div class="balance-group inner">
          <span class="intelligent-icon">智能投资，安享收益</span>
          <a id="slideUpInfo" class="read-more-arrow" href="javascript:void(0)"></a>
        </div>
        <!--<div class="intelligent-financing-text">
          <span class="color-green">“智享计划”</span>是八斗金服（北京）信息技术有限公司在其运营的八斗金服平台上推出的一种智能匹配交易服务。用户委托授权本平台根据其预约时开启的资金锁定期限及投资金额自动匹配条件相符或相近的优质标的。本服务仅向符合中华人民共和国有关法律法规及八斗金服相关规定的合格用户和借款人提供。
        </div>-->
      </div>
    </div>
  </div>
  <div class="footer-bar">
    <a id="investImmediately" class="invest-immediately" href="javascript:void(0);">
      <span id="calculator" class="calculator"><image src="weixin/images/icons/calculator@3x.png" /></span>
      <span>
          <svg id="indicator" class="indicator-wrapper" viewbox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg">
            <circle id="loading" class="indicator-animate" cx="10" cy="10" r="8" fill="transparent" stroke="#fff" stroke-width="1" class="frozeed-assets-circle"
              stroke-dashoffset="7.7654816" stroke-dasharray="42.5 7.7654816"></circle>
            <circle id="loaded" class="indicator-animate-loaded" cx="10" cy="10" r="8" fill="transparent" stroke="#fff" stroke-width="1" class="frozeed-assets-circle"
              stroke-linecap="round" stroke-dashoffset="0" stroke-dasharray="42.5 7.7654816">
            </circle>
            <polyline id="loadedMark" class="indicator-animate-loaded-mark" points="5.8,8.8 10,13.5 18,5" stroke-linecap="round" fill="transparent" stroke="#fff"
              stroke-width="1" stroke-dasharray="0 17.9979633" />
          </svg>
        <span id="buttonTitle">数据加载中...</span></span>
    </a>
  </div>
  <!--计划详情-->
  <div id="red_notice_container" class="slide-up-container">
    <iframe src="./underlying.html" frameborder="0" style="width:100%;height:100%"></iframe>
  </div>
  <!--安心签-->
  <div id="peaceSign" class="alert-wrapper peace-sign" style="display: none;">
    <div class="alert-cont">
      <div id="peaceSignContent">
        <h2 class="alert-title">开通安心签</h2>
        <div class="alert-body">
          <p class="payment-phone"></p>
          <p class="plase-yzm">请输入授权验证码</p>
          <input class="plase-input" type="tel" maxlength="6" name="vcode" placeholder="请输入授权验证码" />
          <a id="obtainYZM" class="obtain-yzm" href="javascript:void(0)">获取授权验证码</a>
          <div class="beCareful-cont">
            <p>安心签是由中国金融认证中心（以下简称“CFCA”）管理的第三方电子缔约服务平台，开通安心签功能，为每一位投资用户的投资合同安全加码。</p>
          </div>
        </div>
      </div>
      <div class="close-img"><img src="weixin/images/close@2x.png" /></div>
    </div>
  </div>
  <div id="investCodeModel" class="invest-code">
    <div class="invest-code-wrapper" style="width: 300px;">
      <h4 class="invest-code-title"></h4>
      <div class="invest-code-content" style="padding: 0 13px 5px;">
        <div class="invest-code-notice">
          <span id="indicatorText" class="indicator-text" style="border-bottom: 1px solid #E7E7E7;text-align: center;">成功预约金额*实际等待天数*5%贴息年利率 </span><br>365天</div>
        <div id="investCodeTip" class="invest-code-tip">等待天数：预约成功当天至匹配成功前一天</div>
        <div class="hidden-input-clip">
          <input type="tel" id="buyCode" maxlength="6" unselectable="on" name="login_code" style="width: 10000px;text-align: right;"
          />
        </div>

        <a class="confirm-code" href="javascript:void(0);">确定</a>
      </div>
    </div>
  </div>
  <!--贴息计算公式-->
  <div id="alertWrapper" class="alert-wrapper" style="display: none;text-align: center;">
    <div class="alert-cont">
      <div id="peaceSignContent">
        <h2 class="alert-title">贴息补偿计算公式</h2>
        <div class="alert-body" style="padding-bottom: 15px">
          <p class="payment-phone"></p>
          <p class="plase-yzm"><span class="indicator-text" style="border-bottom: 1px solid #E7E7E7;text-align: center;padding-bottom:5px;">成功预约金额*实际等待天数*5%贴息年利率 </span>
            <span style="display:block;margin-top:10px;">365天</span>
          </p>
          <div class="invest-code-tip" style="margin-top: 35px">等待天数：预约成功当天至匹配成功前一天的天数</div>
        </div>
      </div>
      <div id="closeAlert" class="close-img"><img src="weixin/images/close@2x.png" /></div>
    </div>
  </div>
</body>

</html>