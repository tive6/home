<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="keywords" content="八斗金服">
  <meta name="description" content="八斗金服">
  <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="format-detection" content="telephone=no" />
  <title>账户充值</title>
  <link rel="stylesheet" type="text/css" href="weixin/css/wechat.css" />
  <script src="weixin/js/require.js" data-main="weixin/js/main" defer="defer" async="async" type="text/javascript" charset="utf-8"></script>
  <script>
    window.onload = function() {
      require.config({
        baseUrl: 'weixin/js',
        paths: {
          // 外部库／插件
          'jquery': [
            '//cdn.bootcss.com/jquery/1.12.4/jquery.min',
            'lib/jquery/1.12.4/jquery.min'
          ],
          'config': 'settings',
          'util': 'common/util',
          'WebView': 'common/webView',
          'investController': 'controller/investController',
          'userController': 'controller/userController'
        }
      });
      require([
        'jquery', 'config', 'util', 'WebView', 'investController', 'userController'
      ], function($, config, util, WebView, investController, userController) {
        var hasBind = false;
        $('#__sbform__').attr('action', config.SERVICE_URI_MAP.FUIOU_RECHARGE);
        userController.getMyAsset(function(asset) {
          if (asset) {
            $('#rechargeBalance').html(asset.getCABalance());
          }
        });

        $('#topUpAmount').on('input', function() {
          if (+$(this).val()) {
            if (!hasBind) {
              hasBind = true;
              $('#recharge').on('click', function() {
                userController.loadUserAuthResult(function(user) {
                  if (!user.getIsAuth()) {
                    WebView.msgAlert({
                      msg: '请先进行实名认证。',
                      action: function() {
                        util.jump2RealNameAuthPage(window.location.href);
                      }
                    }).show();
                  } else {
                    var money = +$('#topUpAmount').val(),
                      source = util.getSearchField('backUrl') !== null ? util.getSearchField('backUrl') : window.location
                      .href,
                      options = {
                        amt: money,
                        type: 'recharge',
                        source: decodeURIComponent(source)
                      };
                    investController.rechargeOrWithdraw(options, function(fuiou) {
                      $('[name="login_id"]').val(fuiou.getLoginId());
                      $('[name="mchnt_txn_ssn"]').val(fuiou.getMchntTxnSsn());
                      $('[name="mchnt_cd"]').val(fuiou.getMchntCd());
                      $('[name="signature"]').val(fuiou.getSignature());
                      $('[name="back_notify_url"]').val(fuiou.getBackNotifyUrl());
                      $('[name="amt"]').val(fuiou.getAmt());
                      $('[name="page_notify_url"]').val(fuiou.getPageNotifyUrl());
                      $('#__sbform__').submit();
                    });
                  }
                });
              }).removeClass('btn-disabled');
            }

          } else {
            hasBind = false;
            $('#recharge').off('click').addClass('btn-disabled');
          }
        });

        $('#topUpAmount').trigger('input');

        $('#bankQuota').on('click', function() {
          $('#fuiouBridgeIframe').fadeIn(300);
          $('.recharge-page-wrapper').fadeOut(300);
        });

        var step = 100,
          money = 0;
        $('#subtract').on('click', subtractRecharge);
        $('#plus').on('click', plusRecharge);

        function subtractRecharge() {
          money = +$('#topUpAmount').val() - step;
          money <= 0 ? $('#topUpAmount').val((money = 0)) : $('#topUpAmount').val(money);
          $('#topUpAmount').trigger('input');
        }

        function plusRecharge() {
          money = +$('#topUpAmount').val() + step;
          $('#topUpAmount').val(money);
          $('#topUpAmount').trigger('input');
        }
      });
    };
  </script>
</head>

<body class="recharge-page gray-bg">
  <span id="loading" style="display:none;">loading...</span>
  <div class="recharge-page-wrapper">
    <div class="scroll-content">
      <div class="recharge-group">
        <span>账户余额(元)</span>
        <span id="rechargeBalance" class="recharge">0.00</span>
      </div>
      <div class="recharge-group">
        <span>充值金额(元)</span>
        <div class="table-wrapper amount-wrapper">
          <div id="subtract" class="table-cell center subtract"></div>
          <div class="table-cell amount-input left">
            <input type="number" name="n_top_up" id="topUpAmount" class="form-control" value="" placeholder="100元起" />
          </div>
          <div id="plus" class="table-cell center plus"></div>
        </div>
      </div>
      <div class="btn-group recharge-btn">
        <button id="recharge" class="btn btn-primary btn-disabled">立即充值</button>
      </div>
      <a id="bankQuota" class="btn-secondary prevent-callout" style="display:block;margin:15px auto;text-align:center" href="javascript:void(0);">银行限额</a>
    </div>
  </div>
  <iframe id="fuiouBridgeIframe" src="/bank-list.html" style="width:100%;height:100%;" frameborder="0"></iframe>
  <form id="__sbform__" action="https://jzh-test.fuiou.com/jzh/app/500001.action" method="post">
    <input type="hidden" name="login_id" value="" />
    <input type="hidden" name="mchnt_txn_ssn" value="" />
    <input type="hidden" name="mchnt_cd" value="" />
    <input type="hidden" name="signature" value="" />
    <input type="hidden" name="back_notify_url" value="" />
    <input type="hidden" name="amt" value="" />
    <input type="hidden" name="page_notify_url" value="" />
  </form>
</body>

</html>