<!DOCTYPE html>
<html>

<head>
	<title>摇一摇</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<link rel="stylesheet" type="text/css" href="/weixin/css/wechat.css" />
	<link rel="stylesheet" type="text/css" href="css/style.css" />
	<style type="text/css">
		.msgalert-header {
			background-color: #f7f7f7;
		}
		
		.msgalert-header h3 {
			padding: 0;
			border: none;
		}
		
		.msgalert-content {
			padding: 25px 25px 35px;
		}
		
		.msgalert-footer {
			background: #F9364D;
		}
		
		.msgalert-confirm {
			color: #fff;
		}
	</style>
	<script src="/weixin/js/require.js" data-main="/weixin/js/main" defer="defer" async="async" type="text/javascript" charset="utf-8"></script>
	<script>
		window.onload = function () {
			require.config({
				baseUrl: '/weixin/js',
				paths: {
					// 外部库／插件
					'jquery': [
						'//cdn.bootcss.com/jquery/1.12.4/jquery.min',
						'lib/jquery/1.12.4/jquery.min'
					],
					'cookie': [
						'//cdn.bootcss.com/cookie.js/1.1.0/cookie.min',
						'lib/cookie/1.1.0/cookie.min'
					],
					'Shake': '../../activity/js/lib/shake/shake',
					'WebView': 'common/webView',
					'activityController': '../../activity/js/controller',
					'userController': 'controller/userController'
				}
			});
			require([
				'jquery', 'cookie', 'Shake', 'WebView', 'activityController', 'userController'
			], function ($, cookie, Shake, WebView, activityController, userController) {
				var shake = new Shake(),
					money = 0,
					_code = null;
				shake.start();
				$(window).one('shake', shakeLottery);

				$(".close-btn").click(function () {
					$(".shake-opcity-bg").fadeOut(300);
					$(".big-winning").fadeOut(300);
				});

				function shakeLottery() {
					document.getElementById('shakeAudio').play();
					var user = userController.getLoginUserFromLocalStorage();
					var options = {
						token: user && user.getToken(),
						code: $('#code_cache').html() || null
					};
					// console.log(options);
					activityController.shake4Lottery(options, function (result) {
						// console.log(result)
						switch (result.getStatus()) {
							case '1':
								// 抽奖成功
								setTimeout(function () {
									money = result.getData();
									showPrize(result);
								}, 1000);
								break;
							case '2':
								// 已经抽过
								setTimeout(function () {
									money = result.getData();
									showPrize(result);
								}, 1000);
								break;
							case '3':
								// 3:活动结束
								setTimeout(function () {
									document.getElementById('resultAudio').play();
									WebView.msgAlert({
										title: '<span style="color:#F9364D">系统提示</span>',
										msg: '活动已结束<br/>您可以登陆八斗金服查看获得结果'
									}).show();
								}, 1000);
								break;
							case '4':
								// 4:输口令开始摇奖
								setTimeout(function () {
									document.getElementById('resultAudio').play();
									WebView.msgAlert({
										title: '<span style="color:#F9364D">系统提示</span>',
										msg: result.getData()
									}).show();
								}, 1000);
								break;
							case '5':
								// 已经领过
								$('#award').hide();
								setTimeout(function () {
									money = result.getData();
									showPrize(result);
								}, 1000);
								break;
							default:
								break;
						}
						$(window).one('shake', shakeLottery);
					});
				}

				$('#award').on('click', function (e) {
					e.stopPropagation();
					// console.log(_code);
					activityController.award({
						money: money
					});
				});

				function hasLotteried() {
					$('.tok-podium').html('<span style="display:block;margin-bottom:10px;">您已经抽过奖啦！</span>凭此页面上台领奖吧！');
					$('.shake-opcity-bg').fadeIn(300);
					$('#prize').fadeIn(300);
				}

				function showPrize(result) {
					document.getElementById('resultAudio').play();
					if (result.getData()) {
						$('#money').html(result.getData());
					}
					$('.big-winning').fadeIn(300);
					$('.shake-opcity-bg').fadeIn(300);
				}
			});
		};
	</script>
</head>

<body>
	<span style="display: none" id="code_cache"></span>
	<div class="shake-wrapper">
		<img class="logo" src="images/logo.png" alt="八斗金服" />
		<img class="title" src="images/dajidali.png" alt="大鸡大利" />
		<img class="title" src="images/wenzi.png" alt="多鸡多礼" />
		<img class="hongbao" src="images/honbao.png" alt="红包" />
		<img class="shake-money" src="images/bg.png" alt="" />
		<div class="percent" style="bottom: 13%;">用力摇起来吧~</div>
		<!--弹层背景-->
		<div class="shake-opcity-bg" style="display: none;"></div>
	</div>
	<!--开奖-->
	<div class="lottery" style="display: none;"></div>
	<!--获奖-->
	<div class="big-winning" style="display: none;">
		<div class="cash"><sup>￥</sup><span id="money"></span><sub>现金</sub></div>
		<div class="winning-text"></div>
		<div class="receive-btn"><button id="award">立即领取</button></div>
		<div class="winning-position">
			<p>奖金发放至中奖者八斗金服个人账户，实时到账，中奖者可在 【我的账户&gt;账户余额】中查看，该奖金可直接提现或投资哦！
			</p>
		</div>
		<div class="close-btn"><img src="images/close-btn.png" /></div>
	</div>
	<audio id="shakeAudio" preload>
		<source src="/activity/audio/shake/5018.mp3" type="audio/mpeg">
		<source src="/activity/audio/shake/5018.wav" type="audio/wav">
	</audio>
	<audio id="resultAudio" preload>
		<source src="/activity/audio/shake/4092.mp3" type="audio/mpeg">
		<source src="/activity/audio/shake/4092.wav" type="audio/wav">
	</audio>
</body>

</html>