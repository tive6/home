<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="keywords" content="八斗金服">
  <meta name="description" content="八斗金服">
  <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="format-detection" content="telephone=no" />
  <title>修改登录密码</title>
  <link rel="stylesheet" type="text/css" href="weixin/css/wechat.css" />
  <script src="weixin/js/require.js" data-main="weixin/js/main" defer="defer" async="async" type="text/javascript" charset="utf-8"></script>
  <script>
    window.onload = function() {
      require.config({
        baseUrl: 'weixin/js',
        paths: {
          // 外部库／插件
          'jquery': [
            '//cdn.bootcss.com/jquery/1.12.4/jquery.min',
            'lib/jquery/1.12.4/jquery.min'
          ],
          'User': 'model/User',
          'config': 'settings',
          'util': 'common/util',
          'WebView': 'common/webView',
          'userController': 'controller/userController',
          'appController': 'controller/appController'
        }
      });
      require([
        'jquery', 'config', 'util', 'WebView', 'userController', 'appController', 'User'
      ], function($, config, util, WebView, userController, appController, User) {
        // $('[name="n_phone"]').val(userController.getLoginUserFromLocalStorage().getTelphone());

        var hasBinded = false,
          // m32123761728 重置密码
          type = util.getSearchField('__t__'),
          back = util.getSearchField('__b__');
        $('#inputPassword').on('input', bindEvent);
        $('#code').on('input', bindEvent);
        $('[name="n_phone"]').on('input', bindEvent);
        // 重置密码操作锁定手机号为当前登录账号，不可修改
        if (type == 'm32123761728') {
          $('[name="n_phone"]').val(userController.getLoginUserFromLocalStorage().getTelphone());
        } else {
          $('[name="n_phone"]').removeAttr('readonly');
        }

        function bindEvent() {
          var v1 = $('#inputPassword').val(),
            v2 = $('#code').val(),
            v3 = $('[name="n_phone"]').val();
          if (!!v1 && !!v2 && !!v3) {
            if (!hasBinded) {
              hasBinded = true;
              $('#mondifyPassword').one('click', mondify).removeClass('btn-disabled').addClass('btn-primary');
            }
          } else {
            hasBinded = false;
            $('#mondifyPassword').off('click').addClass('btn-disabled').removeClass('btn-primary');
          }
        }

        function mondify() {
          var user = new User();
          $('#indicator').show(0);
          $('#indicatorTitle').html('正在处理中...');
          user.setTelphone($('[name="n_phone"]').val());
          user.setPassword($('[name="n_password"]').val());
          user.setLoginCode($('[name="n_code"]').val());
          if (!validateMP(user)) {
            $('#mondifyPassword').one('click', mondify);
            return;
          }
          userController.mondifyLoginPassword(user, function(res) {
            if (res.getStatus()) {
              $('#loading').hide(0);
              $('#loaded').show(0);
              setTimeout(function() {
                $('#indicatorTitle').html(res.getMsg());
                // 修改成功，按钮动作改为跳转至登录页面
                $('#mondifyPassword').one('click', function() {
                  window.location = config.BASE_URL + config.PAGE_URI_MAP.LOGIN_PAGE + (back ? '?__b__=' + (+back + 1) : '');
                });
                setTimeout(function() {
                  window.location = config.BASE_URL + config.PAGE_URI_MAP.LOGIN_PAGE + (back ? '?__b__=' + (+back + 1) : '');
                }, 1000);
              }, 1400);
            } else {
              $('#indicator').hide(0);
              $('#indicatorTitle').html(res.getMsg());
              $('#mondifyPassword').one('click', mondify);
            }
          }, function(res) {
            $('#indicator').hide(0);
            $('#mondifyPassword').one('click', mondify);
          });
        }

        /**
         * 验证修改密码数据格式
         */
        function validateMP(user) {
          if ('' === user.getLoginCode()) {
            WebView.msgAlert({
              msg: '请输入验证码。',
              action: function() {
                $('#indicator').hide(0);
                $('#indicatorTitle').html('确定');
              }
            }).show();
            return false;
          }
          if (!util.checkTelphone(user.getTelphone())) {
            WebView.msgAlert({
              msg: '请输入有效的手机号。',
              action: function() {
                $('#indicator').hide(0);
                $('#indicatorTitle').html('确定');
              }
            }).show();
            return false;
          }
          if (!util.checkPassword(user.getPassword())) {
            WebView.msgAlert({
              msg: '请输入8-16位数字、字母组合的密码。',
              action: function() {
                $('#indicator').hide(0);
                $('#indicatorTitle').html('确定');
              }
            }).show();
            return false;
          }
          return true;
        }

        // 获取手机验证码
        function getPhoneCode(e) {
          e.stopPropagation();
          var options = {
            codeTag: 'resetpwd',
            telphone: $('[name="n_phone"]').val()
          };
          appController.getPhoneCode(options, $('#getPhoneCode'), function() {
            $('#getPhoneCode').one('click', getPhoneCode);
          });
        }
        $('#getPhoneCode').one('click', getPhoneCode);
        $('#loaded')[0].addEventListener("webkitAnimationEnd", function() {
          $('#loadedMark').show(0);
        }, false);
      });
    };
  </script>
</head>

<body class="modify-password-page">
  <!--修改成功-->
  <div class="successfully-wrapper" style="display: none;">
    <img src="weixin/images/success@2x.png" alt="" />
    <p>修改成功</p>
  </div>
  <div class="modify-password-wrapper">
    <div class="input-group">
      <label for="phone" class="sr-only" title="请输入手机号">请输入手机号</label>
      <input type="tel" maxlength="11" class="form-control" name="n_phone" placeholder="请输入手机号" readonly="readonly" value="" />
      <!--<input type="text" name="n_phone" readonly="readonly" value="">-->
    </div>
    <div class="verification-code">
      <div class="input-group">
        <label for="code" class="sr-only" title="请输入验证码">请输入验证码</label>
        <input type="text" id="code" class="form-control" name="n_code" placeholder="请输入验证码" value="" />
      </div>
      <a id="getPhoneCode" class="btn-secondary prevent-callout" href="javascript:void(0);">获取验证码</a>
    </div>
    <div class="input-group">
      <label for="n_password" class="sr-only" title="请输入8-16位字母、数字密码">请输入8-16位字母、数字密码</label>
      <input type="password" id="inputPassword" class="form-control" name="n_password" placeholder="请输入8-16位字母、数字密码" value="" />
    </div>
    <div class="btn-group">
      <button id="mondifyPassword" class="btn btn-disabled" style="color: #fff;">
        <svg id="indicator" class="indicator-wrapper" style="display:none" viewbox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg">
            <circle id="loading" class="indicator-animate" cx="10" cy="10" r="8" fill="transparent" stroke="#fff" stroke-width="1" class="frozeed-assets-circle"
              stroke-dashoffset="7.7654816" stroke-dasharray="42.5 7.7654816"></circle>
            <circle id="loaded" class="indicator-animate-loaded" cx="10" cy="10" r="8" fill="transparent" stroke="#fff" stroke-width="1" class="frozeed-assets-circle"
              stroke-linecap="round" stroke-dashoffset="0" stroke-dasharray="42.5 7.7654816">
            </circle>
            <polyline id="loadedMark" class="indicator-animate-loaded-mark" points="5.8,8.8 10,13.5 18,5" stroke-linecap="round" fill="transparent" stroke="#fff"
              stroke-width="1" stroke-dasharray="0 17.9979633" />
          </svg>
          <span id="indicatorTitle" class="indicator-title">确定</span>
        </button>
    </div>
  </div>
</body>

</html>