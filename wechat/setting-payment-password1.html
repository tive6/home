<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="keywords" content="八斗金服">
		<meta name="description" content="八斗金服">
		<meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="format-detection" content="telephone=no" />
		<title>设置6位数字支付密码</title>
		<link rel="stylesheet" type="text/css" href="weixin/css/wechat.css" />
		<script src="weixin/js/require.js" data-main="weixin/js/main" defer="defer" async="async" type="text/javascript" charset="utf-8"></script>

	  <script>
	    window.onload = function() {
	      require.config({
	        baseUrl: 'weixin/js',
	        paths: {
	          // 外部库／插件
	          'jquery': [
	            '//cdn.bootcss.com/jquery/1.12.4/jquery.min',
	            'lib/jquery/1.12.4/jquery.min'
	          ],
	          'swiper': [
	            '//cdn.bootcss.com/Swiper/3.4.2/js/swiper.min',
	            'lib/swiper/3.4.2/swiper.min'
	          ],
	          'config': 'settings',
	          'util': 'common/util',
	          'AsyncTaskManager': 'common/asyncTaskManager',
	          'WebView': 'common/webView',
	          'userController': 'controller/userController',
	          'investController': 'controller/investController',
	          'appController': 'controller/appController'
	        }
	      });
	      require([
        'jquery', 'swiper', 'config', 'util', 'AsyncTaskManager', 'WebView', 'userController', 'investController', 'appController'
      	], function ($, Swiper, config, util, AsyncTaskManager, WebView, userController, investController, appController) {
	
					$('#buyCode').val('');
	       	$('#closeAlert').on('click', function (e) {
	          $('.modify-password-alert').fadeOut(300);
	        });
	        
	        var investing = false;
		      $('#codeGroup').on('click', function () {
	          $('#buyCode').focus();
	        });
	
	        var codes = $('#codeGroup span');
	        $('#buyCode').on('keyup', function (e) {
	          var v = this.value.split('');
	          codes.html('&nbsp;');
	          $.each(v, function (idx, item) {
	            $(codes[idx]).html(item);
	          });
	          if (v.length >= 6) {
	            $(this).blur();
	            $(this).attr('disabled', 'disabled');
	            
	          	var cardnum = util.getSearchField('cardnum'),
					      	telphone = util.getSearchField('telphone'),
					      	code = util.getSearchField('code'),
									newPaypwd = $('#buyCode').val();

			        var options = {
				            cardnum : cardnum,
				            telphone : telphone,
			            	code : code,
				            newPaypwd : newPaypwd
				          };
				          
			          userController.changePayPwdByAuth(options, function (res) {
			          	//console.log(res);
			          	if(res.status) {
			          		// 成功
			          		//console.log(res.msg);
			          		window.location.href = '/payment-password.html'; 
			          		$('.confirm-code').click();
			          	}else {
			          		//出錯
			          	}
			          }, function (res) {
		            	failPay(res);
		          	});
	          }
	          
	        });
	
					$(".confirm-code").on("click",function(){
						window.location.href = '/payment-password.html'; 
				  });	
	
	        function failPay(res) {
	          var __t = setTimeout(function () {
	            clearTimeout(__t);
	            investing = false;
	            codes.html('&nbsp;');
	            $('#buyCode').removeAttr('disabled');
	            $('#indicator').hide(0);
	            $('#loadedMark').hide(0);
	            $('#indicatorText').html(res.getMsg());
	            $('#buyCode').val('');
	          }, 1400);
	        }
	        
	      });
	    };
	  </script>
	</head>
	<body class="modify-password-page">
		<div id="investCodeModel" style="display: block;">
      <div class="">
        <div class="">
          <svg id="indicator" style="display: none" class="indicator-wrapper" viewbox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg">
            <circle id="loading" class="indicator-animate" cx="10" cy="10" r="8" fill="transparent" stroke="#f9364e" stroke-width="1"
              class="frozeed-assets-circle" stroke-dashoffset="7.7654816" stroke-dasharray="42.5 7.7654816"></circle>
            <circle id="loaded" class="indicator-animate-loaded" cx="10" cy="10" r="8" fill="transparent" stroke="#f9364e" stroke-width="1"
              class="frozeed-assets-circle" stroke-linecap="round" stroke-dashoffset="0" stroke-dasharray="42.5 7.7654816">
            </circle>
            <polyline id="loadedMark" class="indicator-animate-loaded-mark" points="5.8,8.8 10,13.5 18,5" stroke-linecap="round" fill="transparent"
              stroke="#f9364e" stroke-width="1" stroke-dasharray="0 17.9979633" />
          </svg>
        </div>
        <div class="hidden-input-clip">
          <input type="tel" id="buyCode" maxlength="6" unselectable="on" name="login_code" style="width: 10000px;text-align: right;"
          />
        </div>
        <div id="codeGroup" class="code-group" style="text-align: center;">
          <span class="code-item">&nbsp;</span>
          <span class="code-item">&nbsp;</span>
          <span class="code-item">&nbsp;</span>
          <span class="code-item">&nbsp;</span>
          <span class="code-item">&nbsp;</span>
          <span class="code-item">&nbsp;</span>
        </div>
        <a class="confirm-code" style="margin: -10px auto 25px;" href="javascript:void(0);">确定</a>
        <div class="modify-text"><span style="margin-left: 0px;">为提供更好的支付体验，八斗金服将全面使用6位数字支付密码进行支付验证。</span></div>
      </div>
	  </div>
	</body>
</html>
